---
interface Props {
  logoUrl?: string;
  logoAlt?: string;
  ctaText?: string;
  ctaUrl?: string;
  menuItems?: Array<{
    label: string;
    url: string;
  }>;
  currentLanguage?: "en" | "es";
}

const {
  logoUrl = "/images/logo.svg",
  logoAlt = "Arizona Family Connections",
  ctaText = "Schedule a Visit",
  ctaUrl = "/schedule",
  menuItems = [
    { label: "Home", url: "/" },
    { label: "About", url: "/about" },
    { label: "Services", url: "/services" },
    { label: "Resources", url: "/resources" },
    { label: "Contact", url: "/contact" },
  ],
  currentLanguage = "en",
} = Astro.props;

const currentPath = Astro.url.pathname;

// Normalize: strip language prefix, collapse trailing slashes, ensure leading slash
const basePath =
  currentPath
    .replace(/^\/(en|es)(\/|$)/, "/")
    .replace(/\/+$/, "") || "/";

const cleanPath = basePath === "" ? "/" : basePath;

// Language paths for the toggle (preserve current route)
const englishPath = cleanPath;
const spanishPath = cleanPath === "/" ? "/es/" : `/es${cleanPath}`;

// Determine if on home page
const isHomePage = cleanPath === "/";

// Set logo based on page
const currentLogoUrl = isHomePage ? logoUrl : "/images/logo-dark.svg";

// Logo should always go to the language specific home page
const logoHomePath = currentLanguage === "es" ? "/es/" : "/";

// Determine active menu item
const getIsActive = (url: string) => {
  let normalizedUrl = url.replace(/\/+$/, "");
  if (!normalizedUrl.startsWith("/")) normalizedUrl = `/${normalizedUrl}`;
  if (normalizedUrl === "") normalizedUrl = "/";

  const normalizedPath = cleanPath || "/";

  if (normalizedUrl === "/" || normalizedUrl === "") {
    return normalizedPath === "/" || normalizedPath === "";
  }

  return normalizedPath === normalizedUrl;
};
---

<nav
  class={`navbar ${!isHomePage ? "not-home" : ""}`}
  id="navbar"
  aria-label="Main navigation"
>
  <div class="navbar-container">
    <div class="navbar-left">
      <a href={logoHomePath} class="navbar-logo">
        <img
          src={currentLogoUrl}
          alt={logoAlt}
          width="200"
          height="55"
        />
      </a>

      <ul class="navbar-menu navbar-menu-desktop">
        {menuItems.map((item) => (
          <li>
            <a
              href={item.url}
              class={`navbar-link ${getIsActive(item.url) ? "active" : ""}`}
              aria-current={getIsActive(item.url) ? "page" : undefined}
            >
              {item.label}
            </a>
          </li>
        ))}
      </ul>
    </div>

    <div class="navbar-right">
      <a href={ctaUrl} class="btn btn-secondary">
        {ctaText}
      </a>

      <div class="language-toggle" aria-label="Language selection">
        <a
          href={englishPath}
          class={`language-link ${
            currentLanguage === "en" ? "active" : ""
          }`}
          aria-current={currentLanguage === "en" ? "page" : undefined}
        >
          EN
        </a>
        <span class="language-divider">/</span>
        <a
          href={spanishPath}
          class={`language-link ${
            currentLanguage === "es" ? "active" : ""
          }`}
          aria-current={currentLanguage === "es" ? "page" : undefined}
        >
          ES
        </a>
      </div>

      <button
        class="navbar-hamburger"
        id="hamburgerBtn"
        type="button"
        aria-label="Toggle navigation menu"
        aria-expanded="false"
        aria-controls="mobileMenu"
      >
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
    </div>
  </div>

  <ul class="navbar-menu navbar-menu-mobile" id="mobileMenu">
    {menuItems.map((item) => (
      <li>
        <a
          href={item.url}
          class={`navbar-link ${getIsActive(item.url) ? "active" : ""}`}
          aria-current={getIsActive(item.url) ? "page" : undefined}
        >
          {item.label}
        </a>
      </li>
    ))}

    <li class="mobile-menu-footer">
      <a href={ctaUrl} class="btn btn-secondary btn-mobile">
        {ctaText}
      </a>

      <div class="language-toggle-mobile" aria-label="Language selection">
        <a
          href={englishPath}
          class={`language-link ${
            currentLanguage === "en" ? "active" : ""
          }`}
          aria-current={currentLanguage === "en" ? "page" : undefined}
        >
          EN
        </a>
        <span class="language-divider">/</span>
        <a
          href={spanishPath}
          class={`language-link ${
            currentLanguage === "es" ? "active" : ""
          }`}
          aria-current={currentLanguage === "es" ? "page" : undefined}
        >
          ES
        </a>
      </div>
    </li>
  </ul>
</nav>

<style>
  .navbar {
    background: none;
    border-bottom: none;
    position: fixed;
    top: 0;
    z-index: 1000;
    width: 100%;
    transform: translateY(-100%);
    transition:
      transform var(--duration-std) var(--ease-standard),
      background-color var(--duration-std) var(--ease-standard),
      backdrop-filter var(--duration-std) var(--ease-standard);
  }

  .navbar.visible {
    transform: translateY(0);
  }

  .navbar.scrolled {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow-elev-1);
  }

  .navbar-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: var(--container-xl);
    margin: 0 auto;
    padding: var(--pad-component) var(--pad-component);
    gap: var(--space-2);
  }

  .navbar-left {
    display: flex;
    align-items: center;
    gap: 0;
  }

  .navbar-logo {
    display: inline-flex;
    align-items: center;
    text-decoration: none;
    transition: opacity var(--duration-std) var(--ease-standard);
  }

  .navbar-logo:hover {
    opacity: var(--opacity-hover);
  }

  .navbar-logo img {
    height: 55px;
    width: auto;
  }

  .navbar-menu-desktop {
    display: none;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: var(--space-5);
    align-items: center;
  }

  .navbar-link {
    color: var(--color-text-inverse);
    text-decoration: none;
    font-weight: var(--weight-medium);
    font-size: var(--text-sm);
    padding: var(--space-2) 0;
    border-bottom: 3px solid transparent;
    transition: all var(--duration-std) var(--ease-standard);
  }

  .navbar.not-home .navbar-link,
  .navbar.scrolled .navbar-link {
    color: var(--color-text);
  }

  .navbar-link:hover,
  .navbar-link.active {
    color: var(--color-accent);
    border-bottom-color: var(--color-accent);
  }

  .navbar-link:focus-visible {
    outline: 0;
    box-shadow: var(--focus-ring);
  }

  .navbar-menu-mobile {
    display: none;
    position: fixed;
    top: 80px;
    left: 0;
    right: 0;
    width: 100%;
    flex-direction: column;
    background: var(--color-surface);
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 0;
    animation: slideDown var(--duration-std) var(--ease-decelerate);
    max-height: calc(100vh - 80px);
    overflow-y: auto;
  }

  .navbar-menu-mobile.active {
    display: flex;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .navbar-menu-mobile li {
    width: 100%;
    border-bottom: 1px solid var(--color-border);
  }

  .navbar-menu-mobile .navbar-link {
    display: block;
    width: 100%;
    padding: var(--pad-component);
    font-size: var(--text-body-lg);
    color: var(--color-text);
    text-align: left;
    border-left: 4px solid transparent;
    transition: all var(--duration-std) var(--ease-standard);
  }

  .navbar-menu-mobile .navbar-link:hover,
  .navbar-menu-mobile .navbar-link.active {
    background: var(--color-primary-subtle);
    color: var(--color-primary);
    border-left-color: var(--color-primary);
    border-bottom: 1px solid var(--color-border);
  }

  .mobile-menu-footer {
    padding: var(--pad-component);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    align-items: stretch;
    border-bottom: none;
  }

  .btn-mobile {
    width: 100%;
    text-align: center;
  }

  .language-toggle-mobile {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
  }

  .language-toggle-mobile .language-link {
    color: var(--color-text);
    text-decoration: none;
    padding: var(--space-1) var(--space-2);
    border-bottom: 2px solid transparent;
    transition: all var(--duration-std) var(--ease-standard);
  }

  .language-toggle-mobile .language-link:hover,
  .language-toggle-mobile .language-link.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }

  .language-toggle-mobile .language-divider {
    color: var(--color-text);
  }

  .navbar-right {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .language-toggle {
    display: none;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
  }

  .language-link {
    color: var(--color-text-inverse);
    text-decoration: none;
    padding: var(--space-1) var(--space-3);
    margin-left: var(--space-1);
    border-bottom: 2px solid transparent;
    transition: all var(--duration-std) var(--ease-standard);
  }

  .navbar.not-home .language-link,
  .navbar.scrolled .language-link {
    color: var(--color-text);
  }

  .language-link:hover,
  .language-link.active {
    color: var(--color-accent);
    border-bottom-color: var(--color-accent);
  }

  .language-link:focus-visible {
    outline: 0;
    box-shadow: var(--focus-ring);
  }

  .language-divider {
    color: var(--color-text-inverse);
  }

  .navbar.not-home .language-divider,
  .navbar.scrolled .language-divider {
    color: var(--color-text);
  }

  .navbar-right .btn {
    display: none;
  }

  .navbar-hamburger {
    display: flex;
    flex-direction: column;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: var(--space-2);
    gap: var(--space-2);
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    box-shadow: none;
  }

  .navbar-hamburger:focus-visible {
    outline: 0;
    box-shadow: var(--focus-ring);
  }

  .hamburger-line {
    display: block;
    width: 24px;
    height: 2px;
    background: var(--neutral-0);
    border-radius: 2px;
    transition: all var(--duration-std) var(--ease-standard);
    transform-origin: center;
  }

  .navbar.not-home .hamburger-line,
  .navbar.scrolled .hamburger-line {
    background: var(--neutral-1000);
  }

  .navbar-hamburger.active .hamburger-line:nth-child(1) {
    transform: translateY(10px) rotate(45deg);
  }

  .navbar-hamburger.active .hamburger-line:nth-child(2) {
    opacity: 0;
  }

  .navbar-hamburger.active .hamburger-line:nth-child(3) {
    transform: translateY(-10px) rotate(-45deg);
  }

  @media (min-width: 768px) {
    .navbar-menu-desktop {
      display: flex;
    }

    .navbar-menu-mobile {
      display: none !important;
    }

    .navbar-hamburger {
      display: none;
    }

    .language-toggle {
      display: flex;
    }

    .navbar-right .btn {
      display: inline-flex;
      padding: 8px 24px;
      font-size: var(--text-sm);
    }

    .navbar-container {
      padding: var(--pad-component-lg) var(--pad-component);
    }

    .navbar-left {
      gap: var(--space-6);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .navbar-link,
    .hamburger-line,
    .navbar-menu-mobile,
    .language-link,
    .navbar {
      transition: none;
    }

    .navbar-menu-mobile {
      animation: none;
    }
  }
</style>

<script is:inline>
  function setupNavbar() {
    const hamburgerBtn = document.getElementById("hamburgerBtn");
    const mobileMenu = document.getElementById("mobileMenu");
    const navbar = document.getElementById("navbar");
    const logoImg = document.querySelector(".navbar-logo img");
    const isHomePage = !navbar?.classList.contains("not-home");

    if (hamburgerBtn && mobileMenu) {
      hamburgerBtn.addEventListener("click", () => {
        const isActive = hamburgerBtn.classList.toggle("active");
        mobileMenu.classList.toggle("active");
        hamburgerBtn.setAttribute("aria-expanded", String(isActive));

        document.body.style.overflow = isActive ? "hidden" : "";
      });

      const menuLinks = mobileMenu.querySelectorAll(".navbar-link");
      menuLinks.forEach((link) => {
        link.addEventListener("click", () => {
          hamburgerBtn.classList.remove("active");
          mobileMenu.classList.remove("active");
          hamburgerBtn.setAttribute("aria-expanded", "false");
          document.body.style.overflow = "";
        });
      });
    }

    let lastScrollY = window.scrollY;
    let isScrolled = window.scrollY > 200;

    if (navbar) {
      if (isScrolled) {
        navbar.classList.add("scrolled");
        if (isHomePage && logoImg) logoImg.src = "/images/logo-dark.svg";
      }
      navbar.classList.add("visible");
    }

    window.addEventListener("scroll", () => {
      const currentScrollY = window.scrollY;

      if (currentScrollY > 200 && !isScrolled) {
        navbar?.classList.add("scrolled");
        if (isHomePage && logoImg) logoImg.src = "/images/logo-dark.svg";
        isScrolled = true;
      } else if (currentScrollY < 50 && isScrolled) {
        navbar?.classList.remove("scrolled");
        if (isHomePage && logoImg) logoImg.src = "/images/logo.svg";
        isScrolled = false;
      }

      if (currentScrollY > lastScrollY) {
        navbar?.classList.remove("visible");
      } else {
        navbar?.classList.add("visible");
      }

      lastScrollY = currentScrollY;
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupNavbar);
  } else {
    setupNavbar();
  }

  document.addEventListener("astro:after-swap", setupNavbar);
</script>
