---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

interface Props {
  title: string;
  description?: string;
  limit?: number;
  filter?: "documents" | "forms" | "external";
  decorationLeft?: string;
  decorationRight?: string;
  allResourcesUrl?: string;
  allResourcesText?: string;
  showDivider?: boolean;
  headerPadding?: "sm" | "md" | "lg";
}

const {
  title,
  description,
  limit,
  filter,
  decorationLeft,
  decorationRight,
  allResourcesUrl = "/resources",
  allResourcesText = "View All Resources",
  showDivider = false,
  headerPadding = "md",
} = Astro.props;

type ResourceEntry = CollectionEntry<"resources">;

// Fetch resources from CMS
const allDocuments: ResourceEntry[] = await getCollection("resources");

// Sort by creation date
let sortedDocuments = allDocuments.sort(
  (a, b) =>
    new Date(b.data.id).getTime() - new Date(a.data.id).getTime()
);

// Filter by category if filter is provided
if (filter) {
  sortedDocuments = sortedDocuments.filter(
    (doc) => doc.data.category === filter
  );
}

// Apply limit if provided
const limitedDocuments = limit
  ? sortedDocuments.slice(0, limit)
  : sortedDocuments;

const categoryColors: Record<string, string> = {
  documents: "category-documents",
  forms: "category-forms",
  external: "category-external",
};

const singleCategoryLabels: Record<string, string> = {
  documents: "Document",
  forms: "Form",
  external: "External",
};

interface ResourceLink {
  label: string;
  url: string;
  language?: "en" | "es";
}
---

<section class="resources-section">
  {
    decorationLeft && (
      <div class="decoration decoration-left">
        <img src={decorationLeft} alt="" aria-hidden="true" />
      </div>
    )
  }

  {
    decorationRight && (
      <div class="decoration decoration-right">
        <img src={decorationRight} alt="" aria-hidden="true" />
      </div>
    )
  }

  <div class="resources-container">
    {
      title && (
        <div
          class={`resources-header ${showDivider ? "has-divider" : ""} padding-${headerPadding}`}
        >
          <h2 class="resources-title">{title}</h2>
          {description && (
            <p class="resources-description">{description}</p>
          )}
        </div>
      )
    }

    <div class="resources-grid">
      {limitedDocuments.map((doc) => (
        <div class={`resource-card card-${doc.data.category}`}>
          <div class="resource-header">
            <div class="resource-category">
              <span
                class={`category-badge ${categoryColors[doc.data.category]}`}
              >
                {singleCategoryLabels[doc.data.category]}
              </span>
              {doc.data.language === "both" && (
                <span class="language-badge">EN / ES</span>
              )}
              {doc.data.language === "es" && (
                <span class="language-badge es">ES</span>
              )}
              {doc.data.language === "en" && (
                <span class="language-badge en">EN</span>
              )}
            </div>
          </div>

          <h4 class="resource-title">{doc.data.title}</h4>

          {doc.data.description && (
            <p class="resource-description">{doc.data.description}</p>
          )}

          <div class="resource-links">
            {doc.data.links.map((link: ResourceLink) => (
              <a
                href={link.url}
                class="resource-link"
                target="_blank"
                rel="noopener noreferrer"
              >
                <span class="link-text">
                  {link.label}
                  {link.language === "es" && (
                    <span class="link-lang">(ES)</span>
                  )}
                  {link.language === "en" && (
                    <span class="link-lang">(EN)</span>
                  )}
                </span>
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M7 17L17 7M17 7H7M17 7V17"></path>
                </svg>
              </a>
            ))}
          </div>
        </div>
      ))}
    </div>

    {
      limit && (
        <div class="resources-footer">
          <a href={allResourcesUrl} class="btn btn-text">
            {allResourcesText}
          </a>
        </div>
      )
    }
  </div>
</section>

<style>
  .resources-section {
    position: relative;
    padding: var(--space-9) 0;
    overflow: hidden;
  }

  .decoration {
    position: absolute;
    z-index: 0;
    pointer-events: none;
  }

  .decoration img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .decoration-left {
    left: -10%;
    top: -40px;
    transform: rotate(10deg);
    width: 800px;
    height: auto;
  }

  .decoration-right {
    right: -7%;
    top: 0;
    transform: rotate(-10deg);
    width: 550px;
    height: auto;
  }

  .resources-container {
    position: relative;
    z-index: 1;
    max-width: var(--container-xl);
    margin: 0 auto;
    padding: 0 var(--pad-component-lg);
  }

  .resources-header {
    text-align: center;
    margin-bottom: var(--space-8);
  }

  .resources-header.padding-sm {
    padding-bottom: 0;
  }

  .resources-header.padding-md {
    padding-bottom: var(--space-6);
  }

  .resources-header.padding-lg {
    padding-bottom: var(--space-8);
  }

  .resources-header.has-divider {
    border-bottom: 2px solid var(--color-border);
  }

  .resources-title {
    margin: 0;
    font-size: var(--text-2xl);
    font-weight: var(--weight-bold);
  }

  .resources-description {
    margin: 0;
    font-size: var(--text-base);
    color: var(--color-text-secondary);
    line-height: var(--line-normal);
    max-width: 600px;
    margin: 0 auto;
  }

  .resources-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-6);
  }

  .resource-card {
    padding: var(--space-6);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    background: var(--color-surface);
    transition: all var(--duration-std) var(--ease-standard);
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .card-documents:hover {
    border-color: var(--brand-primary-500);
    box-shadow: 0 0 0 1px var(--brand-primary-500), var(--shadow-md);
    transform: translateY(-4px);
  }

  .card-documents .resource-title {
    color: var(--brand-primary-500);
  }

  .card-documents .resource-link {
    color: var(--brand-primary-500);
  }

  .card-documents .resource-link:hover {
    background: color-mix(
      in srgb,
      var(--brand-primary-500) 8%,
      var(--neutral-50)
    );
    color: var(--brand-primary-600);
  }

  .card-forms:hover {
    border-color: var(--brand-secondary-500);
    box-shadow: 0 0 0 1px var(--brand-secondary-500), var(--shadow-md);
    transform: translateY(-4px);
  }

  .card-forms .resource-title {
    color: var(--brand-secondary-500);
  }

  .card-forms .resource-link {
    color: var(--brand-secondary-500);
  }

  .card-forms .resource-link:hover {
    background: color-mix(
      in srgb,
      var(--brand-secondary-500) 8%,
      var(--neutral-50)
    );
    color: var(--brand-secondary-600);
  }

  .card-external:hover {
    border-color: var(--brand-tertiary-500);
    box-shadow: 0 0 0 1px var(--brand-tertiary-500), var(--shadow-md);
    transform: translateY(-4px);
  }

  .card-external .resource-title {
    color: var(--brand-tertiary-500);
  }

  .card-external .resource-link {
    color: var(--brand-tertiary-500);
  }

  .card-external .resource-link:hover {
    background: color-mix(
      in srgb,
      var(--brand-tertiary-500) 8%,
      var(--neutral-50)
    );
    color: var(--brand-tertiary-600);
  }

  .resource-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
  }

  .resource-category {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .category-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    border-radius: var(--radius-full);
    white-space: nowrap;
  }

  .category-documents {
    background: color-mix(
      in srgb,
      var(--brand-primary-500) 12%,
      var(--neutral-50)
    );
    color: var(--brand-primary-600);
  }

  .category-forms {
    background: color-mix(
      in srgb,
      var(--brand-secondary-500) 12%,
      var(--neutral-50)
    );
    color: var(--brand-secondary-600);
  }

  .category-external {
    background: color-mix(
      in srgb,
      var(--brand-tertiary-500) 12%,
      var(--neutral-50)
    );
    color: var(--brand-tertiary-600);
  }

  .language-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    border-radius: var(--radius-full);
    background: var(--neutral-100);
    color: var(--neutral-700);
    white-space: nowrap;
  }

  .resource-title {
    margin: 0;
    font-size: var(--text-lg);
    font-weight: var(--weight-bold);
    line-height: 1.3;
  }

  .resource-description {
    margin: 0;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-normal);
  }

  .resource-links {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-top: var(--space-2);
  }

  .resource-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    text-decoration: none;
    font-weight: var(--weight-medium);
    font-size: var(--text-sm);
    border-radius: var(--radius-md);
    transition: all var(--duration-std) var(--ease-standard);
    width: fit-content;
  }

  .link-text {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .link-lang {
    font-size: var(--text-xs);
    opacity: 0.7;
  }

  .resource-link svg {
    width: 16px;
    height: 16px;
    transition: transform var(--duration-std) var(--ease-standard);
  }

  .resource-link:hover svg {
    transform: translate(2px, -2px);
  }

  .resources-footer {
    display: flex;
    justify-content: center;
    margin-top: var(--space-8);
  }

  @media (max-width: 1023px) {
    .resources-grid {
      grid-template-columns: 1fr;
    }

    .decoration-left,
    .decoration-right {
      display: none;
    }
  }

  @media (max-width: 767px) {
    .resources-container {
      padding: 0 var(--pad-component);
    }

    .resource-links {
      flex-direction: column;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .resource-card,
    .resource-link,
    .resource-link svg {
      transition: none;
    }

    .resource-card:hover {
      transform: none;
    }

    .resource-link:hover svg {
      transform: none;
    }
  }
</style>

<script>
  const headers = document.querySelectorAll(".accordion-trigger");
  headers.forEach((header) => {
    header.addEventListener("click", () => {
      const item = header.closest(".accordion-item");
      item?.classList.toggle("open");
      header.setAttribute(
        "aria-expanded",
        String(item?.classList.contains("open"))
      );
    });
  });
</script>